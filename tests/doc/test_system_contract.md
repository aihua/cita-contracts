# 测试系统合约功能及重复交易

## 测试系统合约功能

暂时包括共识节点管理合约及配额管理合约

测试步骤(脚本):
0. 调用call获得get类函数返回值(限于系统合约，因为其地址固定)
1. 调用tests/integrate_test/cita_start.sh脚本启动CITA
2. 调用scripts/txtool/txtool/check.py验证CITA启动
3. 调用scripts/txtool/txtool/txtool/make_tx.py构造交易
4. 调用scripts/txtool/txtool/txtool/send_tx发送交易
5. 调用scripts/txtool/txtool/txtool/get_receipt获得receipt内结果验证功能
6. 调用call获得get类函数返回值
以上是通用测试流程，实际测试过程中需要多次调用3-6过程

*以上txtool下脚本使用方法可以查看其README文档*

### 共识节点管理

#### 测试功能1: 增加共识节点
*(默认权限检查为关，如启动CITA时设置了检查权限，权限相关见[权限管理](https://cryptape.github.io/cita/system_management/permission/))*

过程及数据构造:

0. use jsonrpc to check the list of the consensus node

```
curl -X POST --data '{"jsonrpc":"2.0","method":"call", "params":[{"to":"0xffffffffffffffffffffffffffffffffff020001", "data":"0x609df32f"}, "latest"],"id":2}' 127.0.0.1:1337
```

*构造方法详见jsonRPC README文档*

结果:

```
{"jsonrpc":"2.0","id":2,"result":"0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000507f93743cf1dd841b1e9c028a6ed7893c176015dab7f938478e4f80781c0e0c786b2efbbca68a2248e9b5b04c2c10681800c4ff7e1307fd7d4eab7715f12bd7b684f1c958c15548ebbce378726c9cf4d000000000000000000000000000000000"}
```

其中:
* `result`: 获得具体的共识节点数据需要解析。解析方法参考 [contract ABI](https://github.com/ethereum/wiki/wiki/Ethereum-Contract-ABI)

1. 由具有增减节点管理的地址进行增加共识节点的操作，测试的增加地址为`0x3f1a71d1d8f073f4e725f57bbe14d67da22f888`。首先调用`new`方法
```
python3 make_tx.py --to "ffffffffffffffffffffffffffffffffff020001" --code "ddad2ffe000000000000000000000000d3f1a71d1d8f073f4e725f57bbe14d67da22f888" --privkey "5f0258a4778057a8a7d97809bd209055b2fbafa654ce7d31ec7191066b9225e6"
```

*构造方法见步骤1*

2. python3 send_tx.py

```
{"jsonrpc":"2.0","id":1,"result":{"hash":"0x54d242d3284181610f663a41f1b0c3e14851ae928065f02a03690660a77f1de4","status":"Ok"}}
```

*具体见步骤2*

3. python3 get_receipt.py

```
{
  "contractAddress": null,
  "cumulativeGasUsed": "0x56b0",
  "logs": [
    {
      "blockHash": "0xbe2a2b5c0b307155cdd78f665ecef6c0464f7b86262ed1f04f187c4028bcf32c",
      "transactionHash": "0x54d242d3284181610f663a41f1b0c3e14851ae928065f02a03690660a77f1de4",
      "transactionIndex": "0x0",
      "topics": [
        "0xfd96b5bdd2e0412ade018159455c7af2bed1366ab61906962a1b5638f29c68c1"
      ],
      "blockNumber": "0x37",
      "address": "0xffffffffffffffffffffffffffffffffff020001",
      "transactionLogIndex": "0x0",
      "logIndex": "0x0",
      "data": "0x000000000000000000000000d3f1a71d1d8f073f4e725f57bbe14d67da22f888"
    }
  ],
  "blockHash": "0xbe2a2b5c0b307155cdd78f665ecef6c0464f7b86262ed1f04f187c4028bcf32c",
  "transactionHash": "0x54d242d3284181610f663a41f1b0c3e14851ae928065f02a03690660a77f1de4",
  "root": null,
  "errorMessage": null,
  "blockNumber": "0x37",
  "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000004000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000208000000000000000000000000000",
  "transactionIndex": "0x0",
  "gasUsed": "0x56b0"
}
```

其中:
* `data`: 为调用合约方法过程中记录的event，可与构造交易时的数据进行对比。check `0x000000000000000000000000d3f1a71d1d8f073f4e725f57bbe14d67da22f888`为测试地址。

4. 调用`approve`升级测试地址为共识节点地址

```
python3 make_tx.py --to "ffffffffffffffffffffffffffffffffff020001" --code "dd4c97a0000000000000000000000000d3f1a71d1d8f073f4e725f57bbe14d67da22f888" --privkey "5f0258a4778057a8a7d97809bd209055b2fbafa654ce7d31ec7191066b9225e6"
```

*构造方法见步骤1*

5. python3 send_tx.py

```
{"jsonrpc":"2.0","id":1,"result":{"hash":"0x2fc76cc95e265bbaf0ded7787d76d34ea02df56f709e2e84168de04b700ad800","status":"Ok"}}
```

*具体见步骤2*

6. python3 get_receipt.py

```
{
  "contractAddress": null,
  "cumulativeGasUsed": "0xced5",
  "logs": [
    {
      "blockHash": "0x0ae7bf0a99b0b4468a718575ebfdd12621898b16df18b113c624faeec0907bbe",
      "transactionHash": "0x2fc76cc95e265bbaf0ded7787d76d34ea02df56f709e2e84168de04b700ad800",
      "transactionIndex": "0x0",
      "topics": [
        "0x5d55f24dd047ef52a5f36ddefc8c424e4b26c8415d8758be1bbb88b5c65e04eb"
      ],
      "blockNumber": "0x3d",
      "address": "0xffffffffffffffffffffffffffffffffff020001",
      "transactionLogIndex": "0x0",
      "logIndex": "0x0",
      "data": "0x000000000000000000000000d3f1a71d1d8f073f4e725f57bbe14d67da22f888"
    }
  ],
  "blockHash": "0x0ae7bf0a99b0b4468a718575ebfdd12621898b16df18b113c624faeec0907bbe",
  "transactionHash": "0x2fc76cc95e265bbaf0ded7787d76d34ea02df56f709e2e84168de04b700ad800",
  "root": null,
  "errorMessage": null,
  "blockNumber": "0x3d",
  "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000010000000000000000040000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000",
  "transactionIndex": "0x0",
  "gasUsed": "0xced5"
}
```

其中:
* `data`: 为调用合约方法过程中记录的event，可与构造交易时的数据进行对比。check `0x000000000000000000000000d3f1a71d1d8f073f4e725f57bbe14d67da22f888`为测试地址。

7. 查看 chain.log

```
20171011 16:28:59 - TRACE - node ad480135eaf2fe211ea23508b0ad014d9e9ffd35
20171011 16:28:59 - TRACE - node bcbd3a00f2b79e2f3f5763b8b832f64077fd3d52
20171011 16:28:59 - TRACE - node 447cab8c53a5474628b857c5707d9ad9090a1502
20171011 16:28:59 - TRACE - node 6f8c4f89e49d8689712873f0a541a87f75a4772c
20171011 16:28:59 - TRACE - node d3f1a71d1d8f073f4e725f57bbe14d67da22f888
```

* chain里可以看到共识节点多了`d3f1a71d1d8f073f4e725f57bbe14d67da22f888`

8. check the consensus node list of the genensis

```
curl -X POST --data '{"jsonrpc":"2.0","method":"call", "params":[{"to":"0xffffffffffffffffffffffffffffffffff020001", "data":"0x609df32f"}, "latest"],"id":2}' 127.0.0.1:1337
```

*结果见步骤0*

9. check the consensus node list of the new

```
curl -X POST --data '{"jsonrpc":"2.0","method":"call", "params":[{"to":"0xffffffffffffffffffffffffffffffffff020001", "data":"0x609df32f"}, "latest"],"id":2}' 127.0.0.1:1337
```

返回结果如下:

```
{"jsonrpc":"2.0","id":2,"result":"0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006436234c42397f76dee7a50880db28965164cfa245cee22b6524d24a9796f29ee8e21f6c65e5326b89e7b5fc36940c1370aaea804353fdfc02a8915bab08666047109571f510abaaab9efeb932bdc3eedfd3f1a71d1d8f073f4e725f57bbe14d67da22f88800000000000000000000000000000000000000000000000000000000"}
```

其中:
* `result`与上步骤中`result`中对比，多了一个共识节点，解析结果多的节点为测试地址*文档暂缺*

### 配额管理

#### 测试功能1: call setDefaultAQL function

过程及数据构造:

0. 由具有设置配额的地址进行设置配额的操作，测试设置的quota为`0x2b0ce58`

```
python3 make_tx.py --to "ffffffffffffffffffffffffffffffffff020003" --code "b107ea120000000000000000000000000000000000000000000000000000000002b0ce58" --privkey "61b760173f6d6b87726a28b93d7fcb4b4f842224921de8fa8e49b983a3388c03"
```

*详见步骤1*

1. `python3 send_tx.py`. 结果如下:

```
{"jsonrpc":"2.0","id":1,"result":{"hash":"0xed8ba4616d4486d7dd83cb5fb8a4eb15fe4795b5b57068f56436bf80437aaeb6","status":"Ok"}}
```

*详见步骤2*

2. `python3 get_receipt.py`. 结果如下:

```
{
  "contractAddress": null,
  "cumulativeGasUsed": "0x1e7f",
  "logs": [
    {
      "blockHash": "0x03fe137252067d396f83196187d2d0651d182bd1c05b047f5784e3c5bf5a7a9f",
      "transactionHash": "0xed8ba4616d4486d7dd83cb5fb8a4eb15fe4795b5b57068f56436bf80437aaeb6",
      "transactionIndex": "0x0",
      "topics": [
        "0x8b477181257c0ad079608a1cd6f3031245b413eb3036d8e12c1038b3a5dfe9db",
        "0x6163636f756e744761734c696d69740000000000000000000000000000000000",
        "0x0000000000000000000000000000000000000000000000000000000002b0ce58",
        "0x000000000000000000000000d3f1a71d1d8f073f4e725f57bbe14d67da22f888"
      ],
      "blockNumber": "0x23",
      "address": "0xffffffffffffffffffffffffffffffffff020003",
      "transactionLogIndex": "0x0",
      "logIndex": "0x0",
      "data": "0x"
    }
  ],
  "blockHash": "0x03fe137252067d396f83196187d2d0651d182bd1c05b047f5784e3c5bf5a7a9f",
  "transactionHash": "0xed8ba4616d4486d7dd83cb5fb8a4eb15fe4795b5b57068f56436bf80437aaeb6",
  "root": null,
  "errorMessage": null,
  "blockNumber": "0x23",
  "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000002000000000400000000000000000000000000000000000200000000000000000000010000020000000000000000000000000000000000000000400000000000000000000000000000000004000000000000002000000080100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000080004000000000000000",
  "transactionIndex": "0x0",
  "gasUsed": "0x1e7f"
}
```

其中:

* `topics`: 为index的event参数。

3. `chain.log`

```
20171012 20:07:24 - TRACE - account_gas_limit: 45141592
```

*check the account gas limit: 45141592*

4. call getAccountGasLimit

```
curl -X POST --data '{"jsonrpc":"2.0","method":"call", "params":[{"to":"0xffffffffffffffffffffffffffffffffff020003", "data":"0xdae99b3a"}, "latest"],"id":2}' 127.0.0.1:1337
```

*详见步骤0*

结果如下:

```
{"jsonrpc":"2.0","id":2,"result":"0x0000000000000000000000000000000000000000000000000000000002b0ce58"}
```

`check the result`

5. set tx quota 999999999

*需要修改make_tx.py中quota值*

```
python3 make_tx.py --privkey "352416e1c910e413768c51390dfd791b414212b7b4fe6b1a18f58007fa894214" --code "606060405234156100105760006000fd5b610015565b610148806100246000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806360fe47b11461004e5780636d4ce63c1461007257610048565b60006000fd5b341561005a5760006000fd5b610070600480803590602001909190505061009c565b005b341561007e5760006000fd5b61008661010a565b6040518082815260200191505060405180910390f35b60006000620186a09150600090505b818110156100cd578060006000508190909055505b80806001019150506100ab565b7fdf7a95aebff315db1b7716215d602ab537373cdb769232aae6055c06e798425b836040518082815260200191505060405180910390a15b505050565b60006000600050549050610119565b905600a165627a7a72305820dbeea32b7d59673d43cc6915f194839ee2561c032a57d7d46ed8433972fd34a20029"
```

*详见步骤1*

6. `python3 send_tx.py`

```
{"jsonrpc":"2.0","id":1,"result":{"hash":"0xfd3899c486542758c618546ff0f24fe60173b25ad64b82632b86da17515312de","status":"Ok"}}
```

*详见步骤2*

7. `python3 get_receipt.py`

```
{
  "contractAddress": "0x73552bc4e960a1d53013b40074569ea05b950b4d",
  "cumulativeGasUsed": "0x0",
  "logs": [],
  "blockHash": "0xe05ebf44c5eabe62f9dfe82d0c2b82cd02e8e6763f3f142b11a47a712cc46976",
  "transactionHash": "0xfd3899c486542758c618546ff0f24fe60173b25ad64b82632b86da17515312de",
  "root": null,
  "errorMessage": "Account gas limit reached.",
  "blockNumber": "0x324",
  "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "transactionIndex": "0x0",
  "gasUsed": "0x0"
}
```

其中:

* `errorMessage`: check `Account gas limit reached.`

### 测试发送重复交易

构造相同nonce和valid_until_block，即为相同交易，结果如下:

*修改make_tx.py脚本*

```
{"jsonrpc":"2.0","id":1,"error":{"code":6,"message":"TxResponse {hash: 1db3aa32e45986232c182e8d84cd68e1342618f87782236d33745cc102fe5af3, status: \"Dup\" }"}}
```

其中:

* `status`: `Dup`即为重复交易
